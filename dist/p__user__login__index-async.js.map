{"version":3,"sources":["src/pages/user/login/index.tsx"],"sourcesContent":["import {Footer} from '@/components';\r\nimport {login} from '@/services/ant-design-pro/api';\r\nimport {UserAddOutlined} from '@ant-design/icons';\r\nimport {history} from '@umijs/max';\r\nimport {Button, Space} from 'antd';\r\nimport {\r\n  AlipayCircleOutlined,\r\n  LockOutlined,\r\n  MobileOutlined,\r\n  TaobaoCircleOutlined,\r\n  UserOutlined,\r\n  WeiboCircleOutlined,\r\n} from '@ant-design/icons';\r\nimport {\r\n  LoginForm,\r\n  ProFormCaptcha,\r\n  ProFormCheckbox,\r\n  ProFormText,\r\n} from '@ant-design/pro-components';\r\nimport {Helmet, useModel} from '@umijs/max';\r\nimport {Alert, App, Tabs} from 'antd';\r\nimport {createStyles} from 'antd-style';\r\nimport React, {useState} from 'react';\r\nimport {flushSync} from 'react-dom';\r\nimport Settings from '../../../../config/defaultSettings';\r\nimport {PLANT_DOC, SYSTEM_LOGO} from \"@/constants\";\r\nimport {errorMessage} from \"napi-postinstall/lib/helpers\";\r\n\r\nconst useStyles = createStyles(({token}) => {\r\n  return {\r\n    action: {\r\n      marginLeft: '8px',\r\n      color: 'rgba(0, 0, 0, 0.2)',\r\n      fontSize: '24px',\r\n      verticalAlign: 'middle',\r\n      cursor: 'pointer',\r\n      transition: 'color 0.3s',\r\n      '&:hover': {\r\n        color: token.colorPrimaryActive,\r\n      },\r\n    },\r\n    lang: {\r\n      width: 42,\r\n      height: 42,\r\n      lineHeight: '42px',\r\n      position: 'fixed',\r\n      right: 16,\r\n      borderRadius: token.borderRadius,\r\n      ':hover': {\r\n        backgroundColor: token.colorBgTextHover,\r\n      },\r\n    },\r\n    container: {\r\n      display: 'flex',\r\n      flexDirection: 'column',\r\n      height: '100vh',\r\n      overflow: 'auto',\r\n      backgroundImage:\r\n        \"url('https://mdn.alipayobjects.com/yuyan_qk0oxh/afts/img/V-_oS6r-i7wAAAAAAAAAAAAAFl94AQBr')\",\r\n      backgroundSize: '100% 100%',\r\n    },\r\n  };\r\n});\r\nconst ActionIcons = () => {\r\n  const {styles} = useStyles();\r\n  return (\r\n    <>\r\n      <AlipayCircleOutlined key=\"AlipayCircleOutlined\" className={styles.action}/>\r\n      <TaobaoCircleOutlined key=\"TaobaoCircleOutlined\" className={styles.action}/>\r\n      <WeiboCircleOutlined key=\"WeiboCircleOutlined\" className={styles.action}/>\r\n    </>\r\n  );\r\n};\r\nconst Lang = () => {\r\n  const {styles} = useStyles();\r\n  return;\r\n};\r\nconst LoginMessage: React.FC<{\r\n  content: string;\r\n}> = ({content}) => {\r\n  return (\r\n    <Alert\r\n      style={{\r\n        marginBottom: 24,\r\n      }}\r\n      message={content}\r\n      type=\"error\"\r\n      showIcon\r\n    />\r\n  );\r\n};\r\nconst Login: React.FC = () => {\r\n  const [userLoginState, setUserLoginState] = useState<API.LoginResult>({});\r\n  const [type, setType] = useState<string>('account');\r\n  const {initialState, setInitialState} = useModel('@@initialState');\r\n  const {styles} = useStyles();\r\n  const {message} = App.useApp();\r\n  const fetchUserInfo = async () => {\r\n    const userInfo = await initialState?.fetchUserInfo?.();\r\n    if (userInfo) {\r\n      flushSync(() => {\r\n        setInitialState((s) => ({\r\n          ...s,\r\n          currentUser: userInfo,\r\n        }));\r\n      });\r\n    }\r\n  };\r\n  const handleSubmit = async (values: API.LoginParams) => {\r\n    let defaultErrorMessage = '';\r\n    try {\r\n      // 登录\r\n      const res = await login({\r\n        ...values,\r\n        type,\r\n      });\r\n      if (res.data !== null) {\r\n        const defaultLoginSuccessMessage = '登录成功！';\r\n        message.success(defaultLoginSuccessMessage);\r\n        await fetchUserInfo();\r\n        const urlParams = new URL(window.location.href).searchParams;\r\n        window.location.href = urlParams.get('redirect') || '/welcome';\r\n        return;\r\n      }\r\n      defaultErrorMessage = '登陆失败! ' + res?.description || '登陆失败! ' + res?.msg ||  '登录失败!'\r\n      throw Error('登陆失败，请重试！');\r\n      // 如果失败去设置用户错误信息\r\n      setUserLoginState(res.data ?? {});\r\n    } catch (error) {\r\n      console.log(error);\r\n      message.error(defaultErrorMessage);\r\n    }\r\n  };\r\n  const {status, type: loginType} = userLoginState;\r\n  return (\r\n    <div className={styles.container}>\r\n      <Helmet>\r\n        <title>\r\n          {'登录'}\r\n          {Settings.title && ` - ${Settings.title}`}\r\n        </title>\r\n      </Helmet>\r\n      <Lang/>\r\n      <div\r\n        style={{\r\n          flex: '1',\r\n          padding: '32px 0',\r\n        }}\r\n      >\r\n        <LoginForm\r\n          contentStyle={{\r\n            minWidth: 280,\r\n            maxWidth: '75vw',\r\n          }}\r\n          logo={<img alt=\"logo\" src={SYSTEM_LOGO}/>}\r\n          title=\"用户中心\"\r\n          subTitle={<a href={PLANT_DOC} target=\"_blank\">编程学习社交圈子</a>}\r\n          actions={\r\n            <Space style={{justifyContent: 'flex-end', width: '100%'}}>\r\n              <Button\r\n                type=\"default\"\r\n                size=\"small\"\r\n                icon={<UserAddOutlined/>}\r\n                onClick={() => history.push('/user/register')}\r\n              >\r\n                注册账号\r\n              </Button>\r\n            </Space>\r\n          }\r\n          initialValues={{\r\n            autoLogin: true,\r\n          }}\r\n          onFinish={async (values) => {\r\n            await handleSubmit(values as API.LoginParams);\r\n          }}\r\n        >\r\n          <Tabs\r\n            activeKey={type}\r\n            onChange={setType}\r\n            centered\r\n            items={[\r\n              {\r\n                key: 'account',\r\n                label: '账户密码登录',\r\n              }\r\n            ]}\r\n          />\r\n\r\n          {status === 'error' && loginType === 'account' && (\r\n            <LoginMessage content={'错误的账户和密码'}/>\r\n          )}\r\n          {type === 'account' && (\r\n            <>\r\n              <ProFormText\r\n                name=\"userAccount\"\r\n                fieldProps={{\r\n                  size: 'large',\r\n                  prefix: <UserOutlined/>,\r\n                }}\r\n                placeholder={'请输入账户'}\r\n                rules={[\r\n                  {\r\n                    required: true,\r\n                    message: '账户是必填项！',\r\n                  },\r\n                ]}\r\n              />\r\n              <ProFormText.Password\r\n                name=\"userPassword\"\r\n                fieldProps={{\r\n                  size: 'large',\r\n                  prefix: <LockOutlined/>,\r\n                }}\r\n                placeholder={'请输入密码'}\r\n                rules={[\r\n                  {\r\n                    required: true,\r\n                    message: '密码是必填项！',\r\n                  },\r\n                  {\r\n                    min: 8,\r\n                    type: \"string\",\r\n                    message: '密码长度不小于8！',\r\n                  },\r\n                ]}\r\n              />\r\n            </>\r\n          )}\r\n\r\n          {status === 'error' && loginType === 'mobile' && <LoginMessage content=\"验证码错误\"/>}\r\n          <div\r\n            style={{\r\n              marginBottom: 24,\r\n            }}\r\n          >\r\n            <ProFormCheckbox noStyle name=\"autoLogin\">\r\n              自动登录\r\n            </ProFormCheckbox>\r\n            <a\r\n              style={{\r\n                float: 'right',\r\n              }}\r\n            >\r\n              忘记密码 ?\r\n            </a>\r\n          </div>\r\n        </LoginForm>\r\n      </div>\r\n      <Footer/>\r\n    </div>\r\n  );\r\n};\r\nexport default Login;\r\n"],"names":[],"mappings":";;;;;;;4BA4PA;;;eAAA;;;;;;;mCA5PqB;4BACD;8BACU;4BACR;6BACM;sCAcrB;kCAGoB;wEACG;iCACN;iFACH;kCACgB;;;;;;;;;;;;AAGrC,MAAM,YAAY,IAAA,uBAAY,EAAC,CAAC,EAAC,KAAK,EAAC;IACrC,OAAO;QACL,QAAQ;YACN,YAAY;YACZ,OAAO;YACP,UAAU;YACV,eAAe;YACf,QAAQ;YACR,YAAY;YACZ,WAAW;gBACT,OAAO,MAAM,kBAAkB;YACjC;QACF;QACA,MAAM;YACJ,OAAO;YACP,QAAQ;YACR,YAAY;YACZ,UAAU;YACV,OAAO;YACP,cAAc,MAAM,YAAY;YAChC,UAAU;gBACR,iBAAiB,MAAM,gBAAgB;YACzC;QACF;QACA,WAAW;YACT,SAAS;YACT,eAAe;YACf,QAAQ;YACR,UAAU;YACV,iBACE;YACF,gBAAgB;QAClB;IACF;AACF;AACA,MAAM,cAAc;;IAClB,MAAM,EAAC,MAAM,EAAC,GAAG;IACjB,qBACE;;0BACE,2BAAC,2BAAoB;gBAA4B,WAAW,OAAO,MAAM;eAA/C;;;;;0BAC1B,2BAAC,2BAAoB;gBAA4B,WAAW,OAAO,MAAM;eAA/C;;;;;0BAC1B,2BAAC,0BAAmB;gBAA2B,WAAW,OAAO,MAAM;eAA9C;;;;;;;AAG/B;GATM;;QACa;;;KADb;AAUN,MAAM,OAAO;;IACX,MAAM,EAAC,MAAM,EAAC,GAAG;IACjB;AACF;IAHM;;QACa;;;MADb;AAIN,MAAM,eAED,CAAC,EAAC,OAAO,EAAC;IACb,qBACE,2BAAC,WAAK;QACJ,OAAO;YACL,cAAc;QAChB;QACA,SAAS;QACT,MAAK;QACL,QAAQ;;;;;;AAGd;MAbM;AAcN,MAAM,QAAkB;;IACtB,MAAM,CAAC,gBAAgB,kBAAkB,GAAG,IAAA,eAAQ,EAAkB,CAAC;IACvE,MAAM,CAAC,MAAM,QAAQ,GAAG,IAAA,eAAQ,EAAS;IACzC,MAAM,EAAC,YAAY,EAAE,eAAe,EAAC,GAAG,IAAA,aAAQ,EAAC;IACjD,MAAM,EAAC,MAAM,EAAC,GAAG;IACjB,MAAM,EAAC,OAAO,EAAC,GAAG,SAAG,CAAC,MAAM;IAC5B,MAAM,gBAAgB;YACG;QAAvB,MAAM,WAAW,OAAM,yBAAA,oCAAA,8BAAA,aAAc,aAAa,cAA3B,kDAAA,iCAAA;QACvB,IAAI,UACF,IAAA,mBAAS,EAAC;YACR,gBAAgB,CAAC,IAAO,CAAA;oBACtB,GAAG,CAAC;oBACJ,aAAa;gBACf,CAAA;QACF;IAEJ;IACA,MAAM,eAAe,OAAO;QAC1B,IAAI,sBAAsB;QAC1B,IAAI;YACF,KAAK;YACL,MAAM,MAAM,MAAM,IAAA,UAAK,EAAC;gBACtB,GAAG,MAAM;gBACT;YACF;YACA,IAAI,IAAI,IAAI,KAAK,MAAM;gBACrB,MAAM,6BAA6B;gBACnC,QAAQ,OAAO,CAAC;gBAChB,MAAM;gBACN,MAAM,YAAY,IAAI,IAAI,OAAO,QAAQ,CAAC,IAAI,EAAE,YAAY;gBAC5D,OAAO,QAAQ,CAAC,IAAI,GAAG,UAAU,GAAG,CAAC,eAAe;gBACpD;YACF;YACA,sBAAsB,YAAW,gBAAA,0BAAA,IAAK,WAAW;YACjD,MAAM,MAAM;QAGd,EAAE,OAAO,OAAO;YACd,QAAQ,GAAG,CAAC;YACZ,QAAQ,KAAK,CAAC;QAChB;IACF;IACA,MAAM,EAAC,MAAM,EAAE,MAAM,SAAS,EAAC,GAAG;IAClC,qBACE,2BAAC;QAAI,WAAW,OAAO,SAAS;;0BAC9B,2BAAC,WAAM;0BACL,cAAA,2BAAC;;wBACE;wBACA,wBAAQ,CAAC,KAAK,IAAI,CAAC,GAAG,EAAE,wBAAQ,CAAC,KAAK,CAAC,CAAC;;;;;;;;;;;;0BAG7C,2BAAC;;;;;0BACD,2BAAC;gBACC,OAAO;oBACL,MAAM;oBACN,SAAS;gBACX;0BAEA,cAAA,2BAAC,wBAAS;oBACR,cAAc;wBACZ,UAAU;wBACV,UAAU;oBACZ;oBACA,oBAAM,2BAAC;wBAAI,KAAI;wBAAO,KAAK,sBAAW;;;;;;oBACtC,OAAM;oBACN,wBAAU,2BAAC;wBAAE,MAAM,oBAAS;wBAAE,QAAO;kCAAS;;;;;;oBAC9C,uBACE,2BAAC,WAAK;wBAAC,OAAO;4BAAC,gBAAgB;4BAAY,OAAO;wBAAM;kCACtD,cAAA,2BAAC,YAAM;4BACL,MAAK;4BACL,MAAK;4BACL,oBAAM,2BAAC,sBAAe;;;;;4BACtB,SAAS,IAAM,YAAO,CAAC,IAAI,CAAC;sCAC7B;;;;;;;;;;;oBAKL,eAAe;wBACb,WAAW;oBACb;oBACA,UAAU,OAAO;wBACf,MAAM,aAAa;oBACrB;;sCAEA,2BAAC,UAAI;4BACH,WAAW;4BACX,UAAU;4BACV,QAAQ;4BACR,OAAO;gCACL;oCACE,KAAK;oCACL,OAAO;gCACT;6BACD;;;;;;wBAGF,WAAW,WAAW,cAAc,2BACnC,2BAAC;4BAAa,SAAS;;;;;;wBAExB,SAAS,2BACR;;8CACE,2BAAC,0BAAW;oCACV,MAAK;oCACL,YAAY;wCACV,MAAM;wCACN,sBAAQ,2BAAC,mBAAY;;;;;oCACvB;oCACA,aAAa;oCACb,OAAO;wCACL;4CACE,UAAU;4CACV,SAAS;wCACX;qCACD;;;;;;8CAEH,2BAAC,0BAAW,CAAC,QAAQ;oCACnB,MAAK;oCACL,YAAY;wCACV,MAAM;wCACN,sBAAQ,2BAAC,mBAAY;;;;;oCACvB;oCACA,aAAa;oCACb,OAAO;wCACL;4CACE,UAAU;4CACV,SAAS;wCACX;wCACA;4CACE,KAAK;4CACL,MAAM;4CACN,SAAS;wCACX;qCACD;;;;;;;;wBAKN,WAAW,WAAW,cAAc,0BAAY,2BAAC;4BAAa,SAAQ;;;;;;sCACvE,2BAAC;4BACC,OAAO;gCACL,cAAc;4BAChB;;8CAEA,2BAAC,8BAAe;oCAAC,OAAO;oCAAC,MAAK;8CAAY;;;;;;8CAG1C,2BAAC;oCACC,OAAO;wCACL,OAAO;oCACT;8CACD;;;;;;;;;;;;;;;;;;;;;;;0BAMP,2BAAC,kBAAM;;;;;;;;;;;AAGb;IAhKM;;QAGoC,aAAQ;QAC/B;QACC,SAAG,CAAC;;;MALlB;IAiKN,WAAe"}